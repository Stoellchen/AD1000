## https://devices.esphome.io/devices/M5Stack-Dial
## https://docs.m5stack.com/en/core/M5Dial
## https://github.com/GinAndBacon/ESPHome-LVGL-EncoderDial/tree/main
## https://aguacatec.es/integrar-m5stack-dial-en-ha/
## sounds:   https://1j01.github.io/rtttl.js/#Bolero  +  https://rtttl.skully.tech/



substitutions:
# Device customization
# Personalizaci√≥n del dispositivo
  name: m5dial-01
  friendly_name: M5Dial-01
  short_name: Dial-01

  background_color: 'fab02b'
  background_image: m5dial-main-syd-02/images/syd_background_white.jpg
  background_image_saver: m5dial-main-syd-02/images/syd_bg_off.jpg
  background_image_device: m5dial-main-syd-02/images/syd_bg_device.jpg
  background_image_saver_date_time: m5dial-main-syd-02/images/syd_bg_device_off_date_time.jpg



# Icons
# Iconos
  icon_1: mdi:led-strip-variant
  icon_2: mdi:thermostat
  icon_3: mdi:robot-vacuum
  icon_4: mdi:printer
  icon_5: mdi:printer-3d-nozzle
  icon_6: mdi:fan
  icon_7: mdi:air-humidifier
  icon_8: mdi:ceiling-light

  pageicon_plus: mdi:plus
  pageicon_minus: mdi:minus
  pageicon_back: mdi:arrow-left
  pageicon_light_off: mdi:lightbulb_off
  pageicon_light_on: mdi:lightbulb
  pageicon_00: mdi:home-outline
  pageicon_10: mdi:lightbulb-on-outline
  pageicon_20: mdi:speaker-play
  pageicon_30: mdi:air-conditioner
  pageicon_40: mdi:help
  pageicon_50: mdi:help
  pageicon_60: mdi:help
  pageicon_70: mdi:help
  pageicon_80: mdi:help
  pageicon_90: mdi:help



# Sounds
# Sonidos
  menu_sound: 'beep:d=64,o=5,b=255:c7'
  alarm_sound: 'xmen:d=4,o=6,b=200:16f#5,16g5,16b5,16d,c#,8b5,8f#5,p,16f#5,16g5,16b5,16d,c#,8b5,8g5,p,16f#5,16g5,16b5,16d,c#,8b5,8d,2p,8c#,8b5,2p'
  
  sound_menu_clockwise: 'menuclockwise:d=4,o=7,b=225:16c4'
  sound_menu_cclockwise: 'menucclockwise:d=4,o=7,b=225:16f4'
  sound_menu_press: 'menupress:d=2,o=7,b=225:16b4'

  sound_agado: 'agadoo:d=8,o=5,b=125,b=125:b,g#,4e,e,e,4e,e,e,e,e,d#,e,4f#,a,f#,4d#,d#,d#,4d#,d#,d#,d#,d#,c#,d#,4e'
  sound_axel: 'axel:d=8,o=5,b=125,b=125:16g,16g,a#.,16g,16p,16g,c6,g,f,4g,d6.,16g,16p,16g,d#6,d6,a#,g,d6,g6,16g,16f,16p,16f,d,a#,2g,4p,16f6,d6,c6,a#,4g,a#.,16g,16p,16g,c6,g,f,4g,d6.,16g,16p,16g,d#6,d6,a#,g,d6,g6,16g,16f,16p,16f,d,a#,2g'
  sound_bolero: 'bolero:d=16,o=5,b=80,b=80:c6,8c6,b,c6,d6,c6,b,a,8c6,c6,a,4c6,8c6,b,c6,a,g,e,f,2g,g,f,e,d,e,f,g,a,4g,4g,g,a,b,a,g,f,e,d,e,d,8c,8c,c,d,8e,8f,4d,2g'
  sound_bond: '007:d=4,o=5,b=320,b=320:c,8d,8d,d,2d,c,c,c,c,8d#,8d#,2d#,d,d,d,c,8d,8d,d,2d,c,c,c,c,8d#,8d#,d#,2d#,d,c#,c,c6,1b.,g,f,1g.'
  sound_borteus: 'borteus:d=16,o=5,b=160,b=160:b,p,c6,p,d6,b,g,e,b,g,e,c,g,e,c,a4,4p,c6,p,d6,p,e6,c6,a,f,c6,a,f,d,a,f,d,b4,2p,g6,e6,c6,a,f,d,b4,c6,a,f,d,b4,f,d,b4,f,4e.'
  sound_colonel: 'colonel bogey:d=8,o=5,b=140,b=140:g,e,4p,p,e,f,g,e6,p,e6,p,2c6,g,e,4p,p,e,f,e,g,p,g,p,2f,f,d,4p,p,d,e,f,g,e,4p,p,e,f#,e,d,g,p,e,f#,d,p,a,g.,16f#,g,a,g,f,e,d'
  sound_dallas: 'Dallas:d=8,o=5,b=125,b=125:e,4a.,e,4e6.,a,4c#6,b,c#6,4a,4e,4a,4f#6,4e6,c#6,d6,2e6.,p,e,4a,4f#6,4e6,c#6,d6,4e6,b,c#6,4a,4e,4a,c#6,d6,4b.,a,2a'
  sound_final: 'Final Countdown:d=16,o=5,b=125,b=125:b,a,4b,4e,4p,8p,c6,b,8c6,8b,4a,4p,8p,c6,b,4c6,4e,4p,8p,a,g,8a,8g,8f#,8a,4g.,f#,g,4a.,g,a,8b,8a,8g,8f#,4e,4c6,2b.,b,c6,b,a,1b'
  sound_flintstones: 'Flintstones:d=8,o=5,b=200,b=200:g#,4c#,p,4c#6,a#,4g#,4c#,p,4g#,f#,f,f,f#,g#,4c#,4d#,2f,2p,4g#,4c#,p,4c#6,a#,4g#,4c#,p,4g#,f#,f,f,f#,g#,4c#,4d#,2c#'
  sound_fruit: 'Fruit and Nut:d=16,o=5,b=70:d,c#,d,c#,d,p,c#,p,e,p,32d,32f#,32a,32d6,8f#.6,p,g6,f#6,g6,f#6,e6,d6,a,f#,8d.,32f#,32d6,8c#.6,p,b,b4,b4,32b4,32c#,b4,p,a4,p,b,b4,b4,32b4,32c#,b4,p,a4,p,d6,d,d,d,d,c#,e,d,d,c#,b4,a4,8g6,32e6,32c#6,32g,32e,d,c#,d,c#,d,p,c#,p,e,p,32d,32f#,32a,32d6,8f#.6,32p,g6,f#6,g6,f#6,e6,d6,a,f#,8d.,32f#,32d6,8c#.6,p,b,b4,b4,32b4,32c#,b4,p,a4,p,b,b4,b4,32b4,32c#,b4,p,a4,p,b,b4,8b4,8c#,32p,8c#,8d.'
  sound_hawaii: 'Hawaii 5 0:d=16,o=6,b=240:8g#5,p,8g#5,p,8b5,p,4d#,p,2c#.,p,2g#5.,p,8g#5,p,8g#5,p,8f#5,p,4b5,p,1g#5,4p.,8g#5,p,8g#5,p,8b5,p,4d#,p,2c#,8p,2g#.,8p,8f#,p,8f#,p,8d#,p,4b5,p,1g#.,4p,2b,p,8a,8g#,8f#,8e,8d#,8c#,8d#,8b5,2c#,4p,8c#,p,8b,8a,8g,8f#,8d#,8c#,8b5,8c#,4d#,8c#,p,4b5,p,4c#.,p,2g#,4p,8f#,p,8f#,p,8d#,p,4b5,p,1c#6'
  sound_knight: 'Knight Rider:d=32,o=5,b=63,b=63:16e,f,e,8b,16e6,f6,e6,8b,16e,f,e,16b,16e6,4d6,8p,4p,16e,f,e,8b,16e6,f6,e6,8b,16e,f,e,16b,16e6,4f6'
  sound_letitbe: 'Let it be:d=8,o=5,b=100,b=100:16e6,d6,4c6,16e6,g6,a6,g6.,16g6,g6,e6,16d6,c6,16a,g,4e6.,4p,e6,16e6,f6.,e6,e6,d6,16p,16e6,16d6,d6,2c6..'
  sound_mission: 'Mission Impossible:d=16,o=5,b=100:32d,32d#,32d,32d#,32d,32d#,32d,32d#,32d,32d,32d#,32e,32f,32f#,32g,g,8p,g,8p,a#,p,c6,p,g,8p,g,8p,f,p,f#,p,g,8p,g,8p,a#,p,c6,p,g,8p,g,8p,f,p,f#,p,a#,g,2d,32p,a#,g,2c#,32p,a#,g,2c,p,a#4,c'
  sound_mozart: 'Mozart:d=16,o=5,b=125:16d#,c#,c,c#,8e,8p,f#,e,d#,e,8g#,8p,a,g#,g,g#,d#6,c#6,c6,c#6,d#6,c#6,c6,c#6,4e6,8c#6,8e6,32b,32c#6,d#6,8c#6,8b,8c#6,32b,32c#6,d#6,8c#6,8b,8c#6,32b,32c#6,d#6,8c#6,8b,8a#,4g#,d#,32c#,c,c#,8e,8p,f#,e,d#,e,8g#,8p,a,g#,g,g#,d#6,c#6,c6,c#6,d#6,c#6,c6,c#6,4e6,8c#6,8e6,32b,32c#6,d#6,8c#6,8b,8c#6,32b,32c#6,d#6,8c#6,8b,8c#6,32b,32c#6,d#6,8c#6,8b,8a#,4g#'
  sound_muppet: 'Muppet:d=8,o=5,b=250:c6,4c6,4a,4b,a,4b,4g,4p,4c6,4c6,4a,b,a,p,4g.,4p,4e,4e,4g,4f,e,4f,c6,c,d,4e,e,e,p,e,4g,2p,4c6,4c6,4a,4b,a,4b,4g,4p,4c6,4c6,4a,b,4a,4g.,4p,4e,4e,4g,4f,e,4f,c6,c,d,4e,e,4d,d,4c'
  sound_newyear: 'New Year:d=8,o=5,b=125,b=125:a4,4d.,d,4d,4f#,4e.,d,4e,f#,e,4d.,d,4f#,4a,2b.,4b,4a.,f#,4f#,4d,4e.,d,4e,f#,e,4d.,b4,4b4,4a4,2d,16p'
  sound_popcorn: 'Popcorn:d=16,o=5,b=160:a,p,g,p,a,p,e,p,c,p,e,p,8a4,8p,a,p,g,p,a,p,e,p,c,p,e,p,8a4,8p,a,p,b,p,c6,p,b,p,c6,p,a,p,b,p,a,p,b,p,g,p,a,p,g,p,a,p,f,8a,8p,a,p,g,p,a,p,e,p,c,p,e,p,8a4,8p,a,p,g,p,a,p,e,p,c,p,e,p,8a4,8p,a,p,b,p,c6,p,b,p,c6,p,a,p,b,p,a,p,b,p,g,p,a,p,g,p,a,p,b,4c6'
  sound_quofnigt: 'QuoFNigt:d=8,o=5,b=160:16a,16g,16a,16a#,c6,c6,c6,c6,c6,c6,c6,c6,4f.,4p,32f,16e,16f,16g,a,a,a,a,a,a,a,a,4d.,4p,16d,16c,16d,16e,f,f,f,c,g,g,g,c,a,f,a,c6,f6,c6,d6,a#,c6,f,a,c6,f6,c6,d6,a#,4c6,4p,4f.,f,4a4,4p,4e,4p,f,g,f,a,a#,a,f,g,f,d,e,d,c#,d,c#,a4,b4,a4,c#,d,c#,e,f,e,f,g,f,a,a#,a,f,g,f,d,e.'
  sound_rudolf: 'Rudolph the Red Nosed Raindeer:d=8,o=5,b=250:g,4a,g,4e,4c6,4a,2g.,g,a,g,a,4g,4c6,2b.,4p,f,4g,f,4d,4b,4a,2g.,g,a,g,a,4g,4a,2e.,4p,g,4a,a,4e,4c6,4a,2g.,g,a,g,a,4g,4c6,2b.,4p,f,4g,f,4d,4b,4a,2g.,g,a,g,a,4g,4d6,2c.6,4p,4a,4a,4c6,4a,4g,4e,2g,4d,4e,4g,4a,4b,4b,2b,4c6,4c6,4b,4a,4g,4f,2d,g,4a,g,4e,4c6,4a,2g.,g,a,g,a,4g,4c6,2b.,4p,f,4g,f,4d,4b,4a,2g.,4g,4a,4g,4a,2g,2d6,1c.6.'
  sound_startrek: 'Star Trek:d=16,o=5,b=63,b=63:8f.,a#,4d#6.,8d6,a#.,g.,c6.,4f6'
  sound_starwars: 'Star Wars:d=8,o=6,b=180,b=180:f5,f5,f5,2a#5.,2f.,d#,d,c,2a#.,4f.,d#,d,c,2a#.,4f.,d#,d,d#,2c,4p,f5,f5,f5,2a#5.,2f.,d#,d,c,2a#.,4f.,d#,d,c,2a#.,4f.,d#,d,d#,2c'
  sound_takeonme: 'Take On Me:d=8,o=5,b=160,b=160:f#,f#,f#,d,p,b4,p,e,p,e,p,e,g#,g#,a,b,a,a,a,e,p,d,p,f#,p,f#,p,f#,e,e,f#,e,f#,f#,f#,d,p,b4,p,e,p,e,p,e,g#,g#,a,b,a,a,a,e,p,d,p,f#,p,f#,p,f#,e,e5'
  sound_theateam: 'The A Team:d=8,o=5,b=132,b=132:4d#6,a#,2d#6,16p,g#,4a#,4d#.,p,16g,16a#,d#6,a#,f6,2d#6,16p,c#6.,16c6,16a#,g#.,2a#.'
  sound_titanic: 'Titanic:d=8,o=6,b=120,b=120:c,d,2e.,d,c,d,g,2g,f,e,4c,2a5,g5,f5,16d5,16e5,2d5,p,c,d,2e.,d,c,d,g,2g,e,g,2a,2g,16d,16e,2d.'
  sound_vanessamae: 'Vanessa Mae:d=16,o=5,b=140:c6,b,8c6,g,p,g,p,d#,p,d#,p,c,p,c,p,c6,b,8c6,g#,p,g#,p,f,p,8f,c,p,c,p,c6,b,8c6,g,p,g,p,d#,p,d#,p,c,p,c,p,g,f,d#,d,c,d,d#,c,d#,f,8g,8p,8d6,c6,d6,a#,d6,a,d6,g,d6,d6,p,d6,p,d6,p,8d6,c6,d6,a#,d6,a,d6,g,d6,d6,p,d6,p,d6,p,g,f,d#,d,c,d,d#,c,d#,f,4c.'
  sound_waltons: 'Waltons:d=4,o=5,b=120:8d,8d,g,a,b,1b.,2p,8d,8d,g,a,b,2b,1c#.6,8a,8a,e6,d6,c#6,2d.6,1a,p,8a,8a,a,b.,8c6,1b.,2p,8d,8d,g,a,b,1b.,2p,8d,8d,g,a,b,2b,1c#.6,8a,8a,e6,d6,c#6,2d.6,1a,p,8a,8a,a,b.,8a,1g.,2p,a,2b,d6,2e.6,2f.6,2g6,8e6,8e6,g6,f6,e6,1d.6,2p,8d6,8d6,f6,e6,d6,1a.,2p,8a,8b,c6,d6,c6,1b.,2p,a,2b,d6,2e.6,2f.6,2g.6,g6,f#6,e6,2g.6,1d6,p,8d6,8d6,g6,f6,e6,1c.6,2p,8a,8a,d6,c6,b,1g.,2p,8d,8d,g,a,b,1b.,2p,8d,8d,g,a,b,2b,1c#.6,8a,8a,e6,d6,c#6,2d.6,1a,p,8a,8a,a,b.,8a,1g..'


# Example of Lights
# Ejemplo de Luces
  desk_led: light.tira_led_escritorio
  lamp: light.lampara

# Example of Thermostat
# Ejemplo de Termostatos
  climate: climate.salon
  aircon: climate.aircon

# Example of Vacuum
# Ejemplo de Aspirador
  vacuum: vacuum.robot_aspirador

# Example of Switches
# Ejemplo de Enchufes
  printer: switch.regleta_l3
  printer3d: switch.regleta_l4

# Example of dehumidifier
# Ejemplo de Deshumidificador
  dehumidifier: humidifier.deshumidificador
# NFC/RFID Tags
# Etiquetas NFC/RFID
#  tag1: C3-DB-4F-28
#  tag2: 03-55-E5-13
# Other settings
# Otros ajustes
  allowed_characters: " ¬ø?¬°!#%'()+,-./:¬∞0123456789ABCDEFGHIJKLMNOPQRSTUVWYZabcdefghijklmnopqrstuvwxyz√°√©√≠√≥√∫"
################################################################################################################


esphome:
  name: ${name}
  name_add_mac_suffix: false
  friendly_name: ${friendly_name}
  on_boot:
    then:
      - pcf8563.read_time:
      - lambda: 'id(current_page) = "p00";'
      - display.page.show: p00
  platformio_options:
    board_build.flash_mode: dio

esp32:
  board: esp32-s3-devkitc-1
  flash_size: 8MB
  framework:
    type: arduino



# Enable Home Assistant API
api:
  encryption:
#    key: "tEBGrpth5CDdrDidl4Ur1gFNoSOWIg0aeUmV/1s5wmg="
    key: !secret api_encryption_key
  services:
    - service: play_sound
      variables:
        song: string
        volume: int 
      then:
        - lambda: "id(script_rtttl_play).execute(song, volume);"

ota:
  - platform: esphome
    password: !secret ota_encrpytion_key 

wifi:
  # ssid: !secret wifi_ssid
  # password: !secret wifi_password
  # ssid: ReseauTemplier2
  # password: K5Zt53rT&4428
  fast_connect: !secret wifi2_fast_connect
  # power_save_mode: !secret wifi2_power_save_mode
  networks:
  - ssid: !secret wifi2_ssid
    password: !secret wifi2_password
    priority: !secret wifi2_priority
  - ssid: !secret wifi2_ssid_2
    password: !secret wifi2_password_2
    priority: !secret wifi2_priority_2
  - ssid: !secret wifi2_ssid_3
    password: !secret wifi2_password_3
    priority: !secret wifi2_priority_3
  - ssid: !secret wifi2_ssid_4
    password: !secret wifi2_password_4
    priority: !secret wifi2_priority_4
  - ssid: !secret wifi2_ssid_5
    password: !secret wifi2_password_5
    priority: !secret wifi2_priority_5
  domain: !secret wifi2_domain
  

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "${short_name} Fallback Hotspot"
    password: !secret ap_password

mqtt:
  id: mqtt_client  # üëà Das brauchst du!
  broker: !secret m5dial_mqtt_broker
  username: !secret m5dial_mqtt_user
  password: !secret m5dial_mqtt_password
  discovery: false  # optional: verhindert auto-discovery in Home Assistant
  topic_prefix: m5dial_01  # optional: eindeutiger MQTT-Namensraum f√ºr das Ger√§t
  birth_message:
    topic: m5dial_01/status
    payload: online
  will_message:
    topic: m5dial_01/status
    payload: offline
  on_message:
    # f√ºr lichter info liste
    - topic: m5dial/lights
      then:
        - lambda: |-
            id(m5_list_lights).publish_state(x);
    # f√ºr media info liste
    - topic: m5dial/media
      then:
        - lambda: |-
            id(m5_list_media).publish_state(x);
    # f√ºr aircon info liste
    - topic: m5dial/aircon
      then:
        - lambda: |-
            id(m5_list_aircon).publish_state(x);
    # f√ºr statusmessage f√ºr entsprechende selektion auf dem M5
    - topic: m5dial/status/+
      then:
        - lambda: |-
            ESP_LOGD("mqtt", "Status empfangen: %s", x.c_str());
            // Hier: JSON parsen und in Variablen speichern
  on_json_message:
    - topic: m5dial/status/light/+
      then:
      - lambda: |-
          if (x.containsKey("state")) {
            std::string state = x["state"].as<std::string>();
            id(current_light_state) = (state == "on");
            ESP_LOGD("mqtt", "State empfangen: %s", state.c_str());
          }

          if (x.containsKey("brightness")) {
            id(current_light_brightness) = x["brightness"].as<int>();
            ESP_LOGD("mqtt", "Helligkeit empfangen: %d", id(current_light_brightness));
          }

          if (x.containsKey("color")) {
            auto color = x["color"];
            if (color.is<JsonArray>()) {
              int r = color[0].as<int>();
              int g = color[1].as<int>();
              int b = color[2].as<int>();
              id(current_light_color) = Color(r, g, b);
              ESP_LOGD("mqtt", "Farbe empfangen: R=%d G=%d B=%d", r, g, b);
            }
          }
    - topic: m5dial/status/room/light/+
      then:
        - lambda: |-
            if (x.containsKey("brightness")) {
              int brightness = x["brightness"].as<int>();
              id(current_light_brightness) = brightness;
              ESP_LOGD("mqtt", "Raumhelligkeit empfangen: %d", brightness);
            }

            if (x.containsKey("color")) {
              auto color = x["color"];
              if (color.is<JsonArray>()) {
                int r = color[0].as<int>();
                int g = color[1].as<int>();
                int b = color[2].as<int>();
                id(current_light_color) = Color(r, g, b);
                ESP_LOGD("mqtt", "Raumfarbe empfangen: R=%d G=%d B=%d", r, g, b);
              }
            }

script:
  ## smart publish - not too many mqtt in the system
  - id: smart_mqtt_publish
    mode: parallel
    parameters:
      topic: string
      payload: string
      key: string  # z.‚ÄØB. "p1000", "p10000", "media"
    then:
      - lambda: |-
          static std::map<std::string, unsigned long> publish_times;
          unsigned long now = millis();

          unsigned long timeout = (key == "touch") ? 200 : 1000;

          if (publish_times.count(key) == 0 || now - publish_times[key] > timeout) {
            publish_times[key] = now;
            id(mqtt_client)->publish(topic, payload);
            ESP_LOGD("smart_mqtt", "MQTT (%s, %dms): %s ‚Üí %s", key.c_str(), timeout, topic.c_str(), payload.c_str());
          } else {
            ESP_LOGD("smart_mqtt", "MQTT skipped (%s): %lu ms < %lu ms", key.c_str(), now - publish_times[key], timeout);
          }

  - id: reset_inactivity
    mode: queued
    then:
      - lambda: |-
          id(inactivity_time) = 0;

          // Display aktivieren wenn n√∂tig
          if (!id(syd_display).state) {
            id(syd_display).turn_on();
          }

          // Screensaver ggf. beenden
          if (id(screen_saver).state) {
            id(screen_saver).turn_off();
          }

          // Falls das Display auf "locked_screen" ist ‚Üí zur√ºck auf p00
          if (id(current_page) == "locked_screen") {
            id(current_page) = "p00";
            id(round_display).show_page(p00);
          }

  - id: script_rtttl_play
    parameters:
      song: string
      volume: int 
    mode: single
    then:
      - lambda: |-
          float volume_f = (volume>0) ? ((float)clamp(volume, 0, 100))/100.0f : 1.0f;
          id(buzzer).set_max_power(volume_f);
      - rtttl.play:
          rtttl: !lambda 'return (song.find('':'') == std::string::npos) ? ("song:d=16,o=5,b=100:" + song).c_str() : song.c_str();'


  - id: script_play_sound
    parameters:
      rtttlsong: string
    mode: single
    then:
      - if:
          condition:
            switch.is_on: menu_sounds
          then:
#          - rtttl.play: ${rtttlsong}
          - rtttl.play: 
              rtttl: !lambda 'return rtttlsong;'

  - id: play_selected_sound
    parameters:
      rtttlsong: string
    mode: single
    then:
      - if:
          condition:
            lambda: 'return rtttlsong.length() > 0;'
          then:
            - rtttl.play:
                rtttl: !lambda 'return rtttlsong;'

  - id: wake_up_display
    then:
      - switch.turn_on: syd_display
      - light.turn_on:
          id: backlight
          brightness: 100%
      - lambda: 'id(current_page) = "p00";'
      - display.page.show: p00
      - script.execute: reset_inactivity



logger:
  level: DEBUG
#  level: ERROR # nur wenn fehler auftauchen

captive_portal:

## das ist zuviel fuer das board!!!
## M5 Dial sollte dies auch zus√§tzlich k√∂nnen. !!!
# ‚û§ BLE-Tracker aktivieren
# esp32_ble_tracker:
# ‚û§ Optional: BLE-Proxy f√ºr Home Assistant aktivieren
# bluetooth_proxy:
#  active: true


binary_sensor:
  - platform: touchscreen
    name: "Center Select (locked_screen)"
    internal: true
    x_min: 80
    x_max: 160
    y_min: 80
    y_max: 160
    page_id: locked_screen
    on_press:
      then:
        - script.execute: wake_up_display


  ## reihenfolge so ist massgebend !!
  - platform: touchscreen
    name: "p10000 Select Device Details"
    internal: true
    page_id: p10000
    x_min: 80
    x_max: 160
    y_min: 80
    y_max: 104
    on_press:
      then:
        - if:
            condition:
              lambda: 'return id(current_page) == "p10000";'
            then:
              - lambda: |-
                  ESP_LOGD("touch", "Center-Click in Raumgruppe erkannt. Wechsle zu p100000");
              - lambda: 'id(selected_sub_sub_index) = 0;'
              - lambda: |-
                  id(script_play_sound).execute("${sound_menu_press}");
              - lambda: 'id(current_page) = "p100000";'
              - display.page.show: p100000
              - script.execute: reset_inactivity


  ## reihenfolge so ist massgebend !!
  - platform: touchscreen
    name: "p1000 Select Device Group"
    internal: true
    page_id: p1000
    x_min: 80
    x_max: 160
    y_min: 80
    y_max: 104
    on_press:
      then:
        - if:
            condition:
              lambda: 'return id(current_page) == "p1000";'
            then:
              - lambda: |-
                  ESP_LOGD("touch", "Center-Click in Raumgruppe erkannt. Wechsle zu p10000");
              - lambda: 'id(selected_sub_sub_index) = 0;'
              - lambda: |-
                  id(script_play_sound).execute("${sound_menu_press}");
              - lambda: 'id(current_page) = "p10000";'
              - display.page.show: p10000
              - script.execute: reset_inactivity



  ## reihenfolge so ist massgebend !!
  - platform: touchscreen
    name: "p00 Center Select"
    internal: true
    x_min: 80
    x_max: 160
    y_min: 80
    y_max: 160
    page_id: p00
    on_press:
      then:
        - script.execute: reset_inactivity
        - lambda: |-
            ESP_LOGD("touch", "Current Page: %s", id(current_page).c_str());
        - if:
            condition:
              display.is_displaying_page: locked_screen
            then:
            - script.execute: wake_up_display
        ## selektion des devices
        - if:
            condition:
              display.is_displaying_page: p00
            then:
            - if:
                condition:
                  lambda: return id(selected_index) == 1;
                then:
                  - lambda: |-
                      id(selected_sub_index) = 0;
                  - lambda: 'id(current_page) = "p1000";'
                  - display.page.show: p1000



  - platform: touchscreen
    # globaler touch f√ºr back-button ansonsten feuern alle!!
    name: "Global Back Button"
    x_min: 100
    x_max: 140
    y_min: 0
    y_max: 50
    on_press:
      then:
        - lambda: |-
            auto now = millis();
            if (now - id(last_touch_ts) < 500) return;
            id(last_touch_ts) = now;

            if (id(current_page) == "p100000") {
              id(current_page) = "p10000";
              id(round_display).show_page(p10000);
            } 
            else if (id(current_page) == "p10000") {
              id(current_page) = "p1000";
              id(round_display).show_page(p1000);
            } 
            else if (id(current_page) == "p1000") {
              id(current_page) = "p00";
              id(round_display).show_page(p00);
            }

            id(script_play_sound).execute("${sound_menu_press}");
        - script.execute: reset_inactivity

  - platform: touchscreen
    name: "Raumhelligkeit verringern"
    internal: true
    page_id: p1000
    x_min: 10
    x_max: 50
    y_min: 100
    y_max: 140
    on_press:
      - script.execute: reset_inactivity
      - lambda: |-
          std::string topic = "m5dial/set/room/light";
          std::string payload = "{ \"room\": \"" + id(selected_light_room) + "\", \"action\": \"brightness_minus\" }";
          // id(mqtt_client)->publish(topic, payload);
          id(smart_mqtt_publish).execute(topic, payload, "touch");
          // ESP_LOGD("room brightness -", "MQTT: %s ‚Üí %s", topic.c_str(), payload.c_str());

  - platform: touchscreen
    name: "Raumhelligkeit erh√∂hen"
    internal: true
    page_id: p1000
    x_min: 190
    x_max: 240
    y_min: 100
    y_max: 140
    on_press:
      - script.execute: reset_inactivity
      - lambda: |-
          std::string topic = "m5dial/set/room/light";
          std::string payload = "{ \"room\": \"" + id(selected_light_room) + "\", \"action\": \"brightness_plus\" }";
          // id(mqtt_client)->publish(topic, payload);
          id(smart_mqtt_publish).execute(topic, payload, "touch");
          // ESP_LOGD("room brightness +", "MQTT: %s ‚Üí %s", topic.c_str(), payload.c_str());


  - platform: gpio
    name: Hold Button
    pin: GPIO46
    internal: True



select:
  - platform: template
    name: "Soundauswahl"
    id: sound_selector
    icon: "mdi:bell-ring"
    optimistic: true
    options:
      - "Agado"
      - "Axel"
      - "Bolero"
      - "Bond"
      - "Borteus"
      - "Colonel"
      - "Dallas"
      - "Final"
      - "Flintstones"
      - "Fruit"
      - "Hawaii 5-O"
      - "Knight Rider"
      - "Let it be"
      - "Mission Impossible"
      - "Mozart"
      - "Muppet"
      - "New Year"
      - "Popcorn"
      - "Quofnight"
      - "Rudolf"
      - "Start Trek"
      - "Star Wars"
      - "Take on me"
      - "The A-Team"
      - "Titanic"
      - "Vanessa Mae"
      - "Waltons"
    initial_option: "The A-Team"
    restore_value: true
    on_value:
      then:
        - if:
            condition:
              lambda: return id(play_on_select_change);  # globaler Flag
            then:
        - script.execute:
            id: play_selected_sound
            rtttlsong: !lambda |-
              if (x == "Agado") return "${sound_agado}";
              if (x == "Axel") return "${sound_axel}";
              if (x == "Bolero") return "${sound_bolero}";
              if (x == "Bond") return "${sound_bond}";
              if (x == "Borteus") return "${sound_borteus}";
              if (x == "Colonel") return "${sound_colonel}";
              if (x == "Dallas") return "${sound_dallas}";
              if (x == "Final") return "${sound_final}";
              if (x == "Flintstones") return "${sound_flintstones}";
              if (x == "Fruit") return "${sound_fruit}";
              if (x == "Hawaii 5-O") return "${sound_hawaii}";
              if (x == "Knight Rider") return "${sound_knight}";
              if (x == "Let it be") return "${sound_letitbe}";
              if (x == "Mission Impossible") return "${sound_mission}";
              if (x == "Mozart") return "${sound_mozart}";
              if (x == "Muppet") return "${sound_muppet}";
              if (x == "New Year") return "${sound_newyear}";
              if (x == "Popcorn") return "${sound_popcorn}";
              if (x == "Quofnight") return "${sound_quofnigt}";
              if (x == "Rudolf") return "${sound_rudolf}";
              if (x == "Star Trek") return "${sound_startrek}";
              if (x == "Star Wars") return "${sound_starwars}";
              if (x == "Take on me") return "${sound_takeonme}";
              if (x == "The A-Team") return "${sound_theateam}";
              if (x == "Titanic") return "${sound_titanic}";
              if (x == "Vanessa Mae") return "${sound_vanessamae}";
              if (x == "Waltons") return "${sound_waltons}";
              return "";



button:
  - platform: template
    name: "Alarm"
    id: alarm_sound
    icon: "mdi:bell-ring"
    on_press:
    - rtttl.play: ${alarm_sound}
    - switch.turn_on: screen_saver
    - script.execute: reset_inactivity

color:
  - id: background_color
    hex: ${background_color}
  - id: icon_on
    hex: '00dd09'
  - id: icon_off
    hex: '000000'
  - id: icon_big_on
    hex: '24ff02'
  - id: icon_big_off
    hex: '000000'
  - id: dark_orange
    hex: 'd2750b'
  - id: light_orange
    hex: 'f9c699'
  - id: dark_green
    hex: '148506'
  - id: darkest_green
    hex: '106305'
  - id: shiny_green
    hex: '6bff59'
  - id: black
    hex: '000000'
  - id: white
    hex: 'ffffff'
  - id: red
    hex: 'ff0000'
  - id: dark_red
    hex: 'af0000'
  - id: darkest_red
    hex: '6f0000'
  - id: shiny_red
    hex: 'ee4b2b'

font:
  - file: "gfonts://Space Grotesk"
    id: clock_time
    size: 40
    glyphs: ${allowed_characters}
  - file: "gfonts://Space Grotesk"
    id: secondary
    size: 18
    glyphs: ${allowed_characters}
## NEU
  - file: "gfonts://Roboto"
    id: font_small
    size: 16
    glyphs: " |!\"%()+=,-_.:¬∞0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz√§√∂√º√Ñ√ñ√ú√ü"

  - file: "gfonts://Roboto"
    id: font_middle
    size: 24
    glyphs: " |!\"%()+=,-_.:¬∞0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz√§√∂√º√Ñ√ñ√ú√ü"

globals:
  - id: last_touch_ts
    type: unsigned long
    restore_value: no
    initial_value: '0'

  - id: inactivity_time
    type: int
    restore_value: no
    initial_value: '0'
  - id: device
    type: int
    restore_value: no
    initial_value: '0'
# for dropdown
  - id: play_on_select_change
    type: bool
    restore_value: no
    initial_value: 'false'
# for current page
  - id: current_page
    type: std::string
    initial_value: "\"unknown\""
## NEU
  - id: selected_light_room
    type: std::string
    restore_value: no
    initial_value: ''
  - id: selected_index
    type: int
    restore_value: no
    initial_value: '0'
  - id: selected_sub_index
    type: int
    restore_value: no
    initial_value: '0'
  - id: selected_sub_sub_index
    type: int
    restore_value: no
    initial_value: '0'
  - id: current_light_state
    type: bool
    restore_value: no
    initial_value: "false"
  - id: current_light_brightness
    type: int
    restore_value: no
    initial_value: '0'
  - id: current_light_color
    type: esphome::Color
    restore_value: no
    initial_value: "Color(255, 255, 255)"
    
  - id: selected_entity
    type: std::string
    restore_value: no
    initial_value: ''

i2c:
  - id: internal_i2c
    sda: GPIO11
    scl: GPIO12
    scan: False
image:
  - file: ${background_image}
    id: background_image
    resize: 245x245
    type: RGB
    transparency: alpha_channel
  - file: ${background_image_saver}
    id: background_image_saver
    resize: 245x245
    type: RGB
    transparency: alpha_channel
  - file: ${background_image_saver_date_time}
    id: background_image_saver_date_time
    resize: 245x245
    type: RGB
    transparency: alpha_channel
  - file: mdi:home
    id: icon_home
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: mdi:plus-thick
    id: plus
    resize: 30x30
    type: BINARY
    transparency: chroma_key
  - file: mdi:minus-thick
    id: minus
    resize: 30x30
    type: BINARY
    transparency: chroma_key
  - file: mdi:home-map-marker
    id: vacuum_dock
    resize: 30x30
    type: BINARY
    transparency: chroma_key
  - file: mdi:play-box
    id: play_icon
    resize: 30x30
    type: BINARY
    transparency: chroma_key
  - file: mdi:pause-box
    id: pause_icon
    resize: 30x30
    type: BINARY
    transparency: chroma_key
  - file: ${icon_1}
    id: icon_1
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: ${icon_1}
    id: icon_1_big
    resize: 100x100
    type: BINARY
    transparency: chroma_key
    
  - file: ${icon_2}
    id: icon_2
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: ${icon_2}
    id: icon_2_big
    resize: 100x100
    type: BINARY
    transparency: chroma_key
    
  - file: ${icon_3}
    id: icon_3
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: ${icon_3}
    id: icon_3_big
    resize: 100x100
    type: BINARY
    transparency: chroma_key
    
  - file: ${icon_4}
    id: icon_4
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: ${icon_4}
    id: icon_4_big
    resize: 100x100
    type: BINARY
    transparency: chroma_key
    
  - file: ${icon_5}
    id: icon_5
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: ${icon_5}
    id: icon_5_big
    resize: 100x100
    type: BINARY
    transparency: chroma_key
    
  - file: ${icon_6}
    id: icon_6
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: ${icon_6}
    id: icon_6_big
    resize: 100x100
    type: BINARY
    transparency: chroma_key
    
  - file: ${icon_7}
    id: icon_7
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: ${icon_7}
    id: icon_7_big
    resize: 100x100
    type: BINARY
    transparency: chroma_key
    
  - file: ${icon_8}
    id: icon_8
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: ${icon_8}
    id: icon_8_big
    resize: 100x100
    type: BINARY
    transparency: chroma_key

  - file: ${pageicon_light_off}
    id: pageicon_light_off
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: ${pageicon_light_on}
    id: pageicon_light_on
    resize: 40x40
    type: BINARY
    transparency: chroma_key


  - file: ${pageicon_plus}
    id: pageicon_plus
    resize: 40x40
    type: BINARY
    transparency: chroma_key

  - file: ${pageicon_minus}
    id: pageicon_minus
    resize: 40x40
    type: BINARY
    transparency: chroma_key

  - file: ${pageicon_back}
    id: pageicon_back
    resize: 40x40
    type: BINARY
    transparency: chroma_key

  - file: ${pageicon_00}
    id: pageicon_00
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: ${pageicon_00}
    id: pageicon_00_big
    resize: 100x100
    type: BINARY
    transparency: chroma_key

  - file: ${pageicon_10}
    id: pageicon_10
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: ${pageicon_10}
    id: pageicon_10_big
    resize: 100x100
    type: BINARY
    transparency: chroma_key

  - file: ${pageicon_20}
    id: pageicon_20
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: ${pageicon_20}
    id: pageicon_20_big
    resize: 100x100
    type: BINARY
    transparency: chroma_key

  - file: ${pageicon_30}
    id: pageicon_30
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: ${pageicon_30}
    id: pageicon_30_big
    resize: 100x100
    type: BINARY
    transparency: chroma_key

  - file: ${pageicon_40}
    id: pageicon_40
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: ${pageicon_40}
    id: pageicon_40_big
    resize: 100x100
    type: BINARY
    transparency: chroma_key

  - file: ${pageicon_50}
    id: pageicon_50
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: ${pageicon_50}
    id: pageicon_50_big
    resize: 100x100
    type: BINARY
    transparency: chroma_key

  - file: ${pageicon_60}
    id: pageicon_60
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: ${pageicon_60}
    id: pageicon_60_big
    resize: 100x100
    type: BINARY
    transparency: chroma_key

  - file: ${pageicon_70}
    id: pageicon_70
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: ${pageicon_70}
    id: pageicon_70_big
    resize: 100x100
    type: BINARY
    transparency: chroma_key

  - file: ${pageicon_80}
    id: pageicon_80
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: ${pageicon_80}
    id: pageicon_80_big
    resize: 100x100
    type: BINARY
    transparency: chroma_key

  - file: ${pageicon_90}
    id: pageicon_90
    resize: 40x40
    type: BINARY
    transparency: chroma_key
  - file: ${pageicon_90}
    id: pageicon_90_big
    resize: 100x100
    type: BINARY
    transparency: chroma_key




interval:
  - interval: 1s
    then:
      - lambda: |-
          id(inactivity_time) += 1;

          // Screensaver aktivieren
          if (id(auto_lock).state) {
            if (id(inactivity_time) > id(screen_saver_time).state && id(current_page) != "locked_screen") {
              if (!id(screen_saver).state) {
                id(screen_saver).turn_on();
              }
            }

            // Display vollst√§ndig ausschalten nach Timeout
            if (id(inactivity_time) > id(auto_lock_time_out).state) {
              if (id(syd_display).state) {
                id(syd_display).turn_off();
              }
            }

          } else {
            // Wenn Auto-Lock deaktiviert, nur Screensaver aktivieren
            if (id(inactivity_time) > id(screen_saver_time).state && id(current_page) != "locked_screen") {
              if (!id(screen_saver).state) {
                id(screen_saver).turn_on();
              }
            }
          }



light:
  - platform: monochromatic
    name: "Backlight"
    output: backlight_pwm
    id: backlight
    default_transition_length: 0s
    restore_mode: ALWAYS_ON
    internal: True
number:
  - platform: template
    name: "Auto Lock"
    id: auto_lock_time_out
    icon: "mdi:timer-sand"
    optimistic: true
    min_value: 20
    max_value: 300
    step: 10
    unit_of_measurement: "s"
    restore_value: true

  - platform: template
    name: "Screen Saver timeout"
    id: screen_saver_time
    icon: "mdi:screen-rotation-lock"
    optimistic: true
    min_value: 10
    max_value: 300
    step: 10
    unit_of_measurement: "s"
    restore_value: true


output:
  - platform: ledc
    pin: GPIO3
    id: buzzer
  - platform: ledc
    pin: GPIO9
    id: backlight_pwm
#rc522_i2c:
#  - i2c_id: internal_i2c
#    id: tag_reader
#    address: 0x28
#    on_tag:
#      then:
#        - rtttl.play: "success:d=24,o=5,b=100:c,g,b"
#        - homeassistant.tag_scanned: !lambda 'return x;'
rtttl:
  output: buzzer
sensor:
  - platform: rotary_encoder
    id: encoder
    pin_a: GPIO40
    pin_b: GPIO41
    on_clockwise:
      then:
        - script.execute: reset_inactivity
        - lambda: |-
            id(script_play_sound).execute("${sound_menu_clockwise}");
        - if:
            condition:
              display.is_displaying_page: p00
            then:
            - lambda: |-
                id(selected_index) += 1;
                if (id(selected_index) > 9) id(selected_index) = 0;
            - lambda: 'id(current_page) = "p00";'
            - display.page.show: p00

        ## Raeume lichter
        - if:
            condition:
              display.is_displaying_page: p1000
            then:
              - lambda: |-
                  std::string data = id(m5_list_lights).state;
                  id(selected_sub_index) += 1; // keine √ºberpr√ºfung hier - klappt nicht
              - lambda: 'id(current_page) = "p1000";'
              - display.page.show: p1000
        ## Lichter im. Raum einzeln
        - if:
            condition:
              display.is_displaying_page: p10000
            then:
              - lambda: |-
                  std::string data = id(m5_list_lights).state;
                  id(selected_sub_sub_index) += 1; // keine √ºberpr√ºfung hier - klappt nicht
              - lambda: 'id(current_page) = "p10000";'
              - display.page.show: p10000

        - script.execute: reset_inactivity


    on_anticlockwise:
      then:
        - script.execute: reset_inactivity
        - lambda: |-
            id(script_play_sound).execute("${sound_menu_cclockwise}");
        - if:
            condition:
              display.is_displaying_page: p00
            then:
            - lambda: |-
                id(selected_index) -= 1;
                if (id(selected_index) < 0 ) id(selected_index) = 9;
            - lambda: 'id(current_page) = "p00";'
            - display.page.show: p00
        ## Raeume lichter
        - if:
            condition:
              display.is_displaying_page: p1000
            then:
              - lambda: |-
                  id(selected_sub_index) -= 1;
              - lambda: 'id(current_page) = "p1000";'
              - display.page.show: p1000
        ## Lichter im. Raum einzeln
        - if:
            condition:
              display.is_displaying_page: p10000
            then:
              - lambda: |-
                  std::string data = id(m5_list_lights).state;
                  id(selected_sub_sub_index) -= 1; // keine √ºberpr√ºfung hier - klappt nicht
              - lambda: 'id(current_page) = "p10000";'
              - display.page.show: p10000

        - script.execute: reset_inactivity


  - platform: homeassistant
    id: desk_led_brightness
    entity_id: ${desk_led}
    attribute: brightness
    internal: true
    filters:
      - lambda: |-
          if (isnan(x)) { return 0; }
          else { return x; }
  - platform: homeassistant
    id: thermostat_temperature
    entity_id: ${climate}
    attribute: temperature
    internal: true
  - platform: homeassistant
    id: aircon_temperature
    entity_id: ${aircon}
    attribute: temperature
    internal: true
  - platform: homeassistant
    id: dehumidifier_humidity
    entity_id: ${dehumidifier}
    attribute: humidity
    internal: true
  - platform: homeassistant
    id: lamp_brightness
    entity_id: ${lamp}
    attribute: brightness
    internal: true
    filters:
      - lambda: |-
          if (isnan(x)) { return 0; }
          else { return x; }
spi:
  id: spi_bus
  mosi_pin: GPIO5
  clk_pin: GPIO6
switch:
  - platform: template
    name: "Auto Lock"
    id: auto_lock
    icon: "mdi:lock-clock"
    optimistic: true
    restore_mode: 'restore_default_off'

  - platform: template
    name: "Display"
    id: syd_display
    icon: "mdi:fit-to-screen"
    optimistic: true
    restore_mode: 'always_on'
    on_turn_on:
      - light.turn_on:
          id: backlight
          brightness: 100%
      - script.execute: reset_inactivity

    on_turn_off:
      - light.turn_off: backlight
      - lambda: 'id(current_page) = "p00";'
      - display.page.show: p00
      - lambda: |-
          id(device) = 0;

  - platform: template
    name: "Screen Saver"
    id: screen_saver
    icon: "mdi:screen-rotation-lock"
    optimistic: true
    restore_mode: 'always_off'
    internal: true
    on_turn_on:
      - light.turn_on:
          id: backlight
          brightness: 30%
      - lambda: 'id(current_page) = "locked_screen";'
      - display.page.show: locked_screen
      - lambda: |-
          id(device) = 0;

  - platform: template
    name: "Menu Sounds"
    id: menu_sounds
    icon: "mdi:playlist-music"
    optimistic: true
    restore_mode: 'restore_default_on'

text_sensor:
  - platform: homeassistant
    id: device_desk_led
    entity_id: ${desk_led}
    internal: true
  - platform: homeassistant
    id: device_thermostat
    entity_id: ${climate}
    internal: true
  - platform: homeassistant
    id: device_vacuum
    entity_id: ${vacuum}
    internal: true
  - platform: homeassistant
    id: device_printer
    entity_id: ${printer}
    internal: true
  - platform: homeassistant
    id: device_printer3d
    entity_id: ${printer3d}
    internal: true
  - platform: homeassistant
    id: device_dehumidifier
    entity_id: ${dehumidifier}
    internal: true
  - platform: homeassistant
    id: device_aircon
    entity_id: ${aircon}
    internal: true
  - platform: homeassistant
    id: device_lamp
    entity_id: ${lamp}
    internal: true

## meine standard sensoren
  - platform: version
    hide_timestamp: true
    name: "ESPHome Version"
    entity_category: diagnostic
  - platform: wifi_info
    ip_address:
      name: "IP Address"
      icon: mdi:wifi
      entity_category: diagnostic
    ssid:
      name: "Connected SSID"
      icon: mdi:wifi-strength-2
      entity_category: diagnostic

## NEU ####################################
#  - platform: homeassistant
#    id: m5_list_lights
#    entity_id: input_text.m5_list_lights
#  - platform: homeassistant
#    id: m5_list_media
#    entity_id: input_text.m5_list_media
#  - platform: homeassistant
#    id: m5_list_aircon
#    entity_id: input_text.m5_list_aircon

  - platform: template
    id: m5_list_lights
    name: M5 Lights from MQTT
  - platform: template
    id: m5_list_media
    name: M5 Media from MQTT
  - platform: template
    id: m5_list_aircon
    name: M5 Aircon from MQTT




time:
  # RTC
  - platform: pcf8563
    id: rtctime
    i2c_id: internal_i2c
    address: 0x51
    update_interval: never
  - platform: homeassistant
    id: esptime
    on_time_sync:
      then:
        - pcf8563.write_time:
touchscreen:
  - platform: ft5x06
    id: touchscreen_syd
    i2c_id: internal_i2c
    address: 0x38
    on_touch:
      - script.execute: reset_inactivity
      - lambda: |-
          int tx = touch.x;
          int ty = touch.y;

          // Nur ausl√∂sen, wenn p10000 UND innerhalb des Helligkeitsbalkens
          //if (id(current_page) == "p10000" && tx >= 30 && tx <= 210 && ty >= 170 && ty <= 200) {
          if ( (id(current_page) == "p1000" || id(current_page) == "p10000" || id(current_page) == "p100000" ) && tx >= 30 && tx <= 210 && ty >= 170 && ty <= 200) 
          {
            int relative_x = tx - 30;
            int brightness = (relative_x * 255) / 180;
            id(current_light_brightness) = brightness;

            if (id(current_page) == "p100000") 
            {
              std::string topic = "m5dial/set/light/" + id(selected_entity);
              std::string payload = "{ \"entity_id\": \"light." + id(selected_entity)+"\", \"state\": \"on\", \"brightness\": " + std::to_string(brightness) + "}";
              // id(mqtt_client)->publish(topic, payload);
              id(smart_mqtt_publish).execute(topic, payload, "touch");
              // ESP_LOGD("brightness_touch", "MQTT: %s ‚Üí %s", topic.c_str(), payload.c_str());
            }
            else if (id(current_page) == "p10000") 
            {
              std::string topic = "m5dial/set/light/" + id(selected_entity);
              std::string payload = "{ \"entity_id\": \"light." + id(selected_entity)+"\", \"state\": \"on\", \"brightness\": " + std::to_string(brightness) + "}";
              // id(mqtt_client)->publish(topic, payload);
              id(smart_mqtt_publish).execute(topic, payload, "touch");
              // ESP_LOGD("brightness_touch", "MQTT: %s ‚Üí %s", topic.c_str(), payload.c_str());
            }
            else if (id(current_page) == "p1000") 
            {
              std::string room = id(selected_light_room);
              std::string topic = "m5dial/set/room/light";
              std::string payload = "{ \"room\": \"" + room + "\", \"action\": \"brightness_absolut\", \"value\": " + std::to_string(brightness) + " }";
              // id(mqtt_client)->publish(topic, payload);
              id(smart_mqtt_publish).execute(topic, payload, "touch");
              // ESP_LOGD("touch", "Raumhelligkeit ge√§ndert (%s) ‚Üí %d", room.c_str(), brightness);
            }
          }


          // On/Off Button auf Seite p100000 (links oben)
          if (id(current_page) == "p100000" && tx >= 19 && tx <= 59 && ty >= 74 && ty <= 114) {
            bool new_state = !id(current_light_state);  // Toggle state
            id(current_light_state) = new_state;

            std::string topic = "m5dial/set/light/" + id(selected_entity);
            std::string payload = "{  \"entity_id\": \"light." + id(selected_entity)+"\", \"state\": \"" + (new_state ? "on" : "off") + "\" }";

            // id(mqtt_client)->publish(topic, payload);
            id(smart_mqtt_publish).execute(topic, payload, "touch");

            // ESP_LOGD("touch_onoff", "MQTT Toggle gesendet: %s ‚Üí %s", topic.c_str(), payload.c_str());
          }

          // Farbe auslesen  auf Seite p100000 und p1000 (√ºber helligkeit)
          if ( (id(current_page) == "p100000" || id(current_page) == "p1000" ) && tx >= 30 && tx <= 210 && ty >= 140 && ty <= 160) 
          {
            int relative_x = tx - 30;
            float t = float(relative_x) / 179.0f;

            uint8_t r, g, b;
            if (t < 1.0f / 6.0f) {
              r = 255;
              g = uint8_t(t * 6.0f * 255.0f);
              b = 0;
            } else if (t < 2.0f / 6.0f) {
              r = uint8_t((2.0f / 6.0f - t) * 6.0f * 255.0f);
              g = 255;
              b = 0;
            } else if (t < 3.0f / 6.0f) {
              r = 0;
              g = 255;
              b = uint8_t((t - 2.0f / 6.0f) * 6.0f * 255.0f);
            } else if (t < 4.0f / 6.0f) {
              r = 0;
              g = uint8_t((4.0f / 6.0f - t) * 6.0f * 255.0f);
              b = 255;
            } else if (t < 5.0f / 6.0f) {
              r = uint8_t((t - 4.0f / 6.0f) * 6.0f * 255.0f);
              g = 0;
              b = 255;
            } else {
              r = 255;
              g = 0;
              b = uint8_t((1.0f - t) * 6.0f * 255.0f);
            }

            id(current_light_color) = Color(r, g, b);

            if (id(current_page) == "p100000")
            {
              std::string entity = id(selected_entity);
              std::string topic = "m5dial/set/light/" + entity;
              std::string payload = "{ \"entity_id\": \"light." + entity + "\", \"state\": \"on\", \"color\": [" + std::to_string(r) + "," + std::to_string(g) + "," + std::to_string(b) + "] }";
              id(mqtt_client)->publish(topic, payload);
              ESP_LOGD("touch", "Farbe ge√§ndert f√ºr %s ‚Üí RGB(%d,%d,%d)", entity.c_str(), r, g, b);
            } 
            else if (id(current_page) == "p1000") 
            {
              // Alle eingeschalteten Lichter im Raum aktualisieren
              std::string room = id(selected_light_room);
              std::string topic = "m5dial/set/room/light";
              std::string payload = "{ \"room\": \"" + room + "\", \"action\": \"color\", \"value\": [" + std::to_string(r) + "," + std::to_string(g) + "," + std::to_string(b) + "] }";
              id(mqtt_client)->publish(topic, payload);
              ESP_LOGD("touch", "Raumfarbe ge√§ndert (%s) ‚Üí RGB(%d,%d,%d)", room.c_str(), r, g, b);
            }

          }


display:
  - platform: ili9xxx
    id: round_display
    model: GC9A01A
    cs_pin: GPIO7
    reset_pin: GPIO8
    update_interval: 0.05s
    dc_pin: GPIO4
    invert_colors: true
    pages:
      - id: locked_screen_old
        lambda: |-
          it.fill(id(background_color));
          it.image(0, 0, id(background_image_saver_date_time));
          it.strftime(120, 26, id(clock_time), TextAlign::CENTER, "%H:%M", id(esptime).now());
          it.strftime(120, 217, id(secondary), TextAlign::CENTER, "%d/%m/%y", id(esptime).now());

      - id: locked_screen
        lambda: |-
          it.fill(id(background_color));

          // Matrix-Effekt (vor Hintergrundbild)
          static int frame = 0;
          static std::vector<int> columns(16, 0);
          static std::string chars = "01ABCDEFGHIJKLMNOPQRSTUVWXYZ";
          frame++;

          for (int i = 0; i < columns.size(); i++) {
            int x = i * 15;
            int y = columns[i] * 15;
            char c = chars[rand() % chars.size()];

            // Draw character in green
            it.printf(x + 2, y, id(font_small), Color(0, 255, 100), TextAlign::TOP_LEFT, "%c", c);

            columns[i] += 1;
            if (columns[i] * 15 > 240 || rand() % 10 == 0) {
              columns[i] = 0;
            }
          }

          // Hintergrundbild (dar√ºber)
          it.image(0, 0, id(background_image_saver_date_time));

          // Uhrzeit und Datum (oberste Schicht)
          it.strftime(120, 26, id(clock_time), TextAlign::CENTER, "%H:%M", id(esptime).now());
          it.strftime(120, 217, id(secondary), TextAlign::CENTER, "%d/%m/%y", id(esptime).now());


      - id: p00
        lambda: |-
          // Hintergrund l√∂schen
          it.fill(black);

          // Kreis-Mittelpunkt
          const int cx = 120;
          const int cy = 120;
          const int r = 85;


          // Texte f√ºr Buttons im Uhrzeigersinn
          std::vector<std::string> labels = {
            "Home", "Licht", "Media", "Klima",
            "Frei1", "Frei2", "Frei3", "Frei4", "Frei5", "Frei6"
          };

          // Zeichne kreisf√∂rmige Button-Beschriftungen
          for (int i = 0; i < labels.size(); i++) {
            float angle = i * 36.0f * 3.14159f / 180.0f;
            int x = cx + int(r * sin(angle));
            int y = cy - int(r * cos(angle));
            
             switch(i) 
             {
                case 0: 
                  it.image(x - 20, y - 20, id(pageicon_00)  , id(dark_green) ); 
                  break;
                case 1: 
                  it.image(x - 20, y - 20, id(pageicon_10)  , id(dark_green) ); 
                  break;
                case 2: 
                  it.image(x - 20, y - 20, id(pageicon_20)  , id(dark_green) ); 
                  break;
                case 3: 
                  it.image(x - 20, y - 20, id(pageicon_30)  , id(dark_green) ); 
                  break;
                case 4: 
                  it.image(x - 20, y - 20, id(pageicon_40)  , id(dark_green) ); 
                  break;
                case 5: 
                  it.image(x - 20, y - 20, id(pageicon_50)  , id(dark_green) ); 
                  break;
                case 6: 
                  it.image(x - 20, y - 20, id(pageicon_60)  , id(dark_green) ); 
                  break;
                case 7: 
                  it.image(x - 20, y - 20, id(pageicon_70)  , id(dark_green) ); 
                  break;
                case 8: 
                  it.image(x - 20, y - 20, id(pageicon_80)  , id(dark_green) ); 
                  break;
                case 9: 
                  it.image(x - 20, y - 20, id(pageicon_90)  , id(dark_green) ); 
                  break;
             }


            if (i == id(selected_index)) 
            {
              // it.print(x, y, id(font_small), shiny_green, TextAlign::CENTER, labels[i].c_str());
              // it.print(cx, cy, id(font_middle), shiny_green, TextAlign::CENTER,  labels[i].c_str() );
              
              switch(i) {
                case 0: 
                    it.image(x - 20, y - 20, id(pageicon_00)  , id(shiny_green) ); 
                    it.image(cx - 50, cy - 50, id(pageicon_00_big)  , id(shiny_green) ); 
                    break;
                case 1: 
                  it.image(x - 20, y - 20, id(pageicon_10)  , id(shiny_green) ); 
                  it.image(cx - 50, cy - 50, id(pageicon_10_big)  , id(shiny_green) ); 
                  break;
                case 2: 
                  it.image(x - 20, y - 20, id(pageicon_20)  , id(shiny_green) ); 
                  it.image(cx - 50, cy - 50, id(pageicon_20_big)  , id(shiny_green) ); 
                  break;
                case 3: 
                  it.image(x - 20, y - 20, id(pageicon_30)  , id(shiny_green) ); 
                  it.image(cx - 50, cy - 50, id(pageicon_30_big)  , id(shiny_green) ); 
                  break;
                case 4: 
                  it.image(x - 20, y - 20, id(pageicon_40)  , id(shiny_green) ); 
                  it.image(cx - 50, cy - 50, id(pageicon_40_big)  , id(shiny_green) ); 
                  break;
                case 5: 
                  it.image(x - 20, y - 20, id(pageicon_50)  , id(shiny_green) ); 
                  it.image(cx - 50, cy - 50, id(pageicon_50_big)  , id(shiny_green) ); 
                  break;
                case 6: 
                  it.image(x - 20, y - 20, id(pageicon_60)  , id(shiny_green) ); 
                  it.image(cx - 50, cy - 50, id(pageicon_60_big)  , id(shiny_green) ); 
                  break;
                case 7: 
                  it.image(x - 20, y - 20, id(pageicon_70)  , id(shiny_green) ); 
                  it.image(cx - 50, cy - 50, id(pageicon_70_big)  , id(shiny_green) ); 
                  break;
                case 8: 
                  it.image(x - 20, y - 20, id(pageicon_80)  , id(shiny_green) ); 
                  it.image(cx - 50, cy - 50, id(pageicon_80_big)  , id(shiny_green) ); 
                  break;
                case 9: 
                  it.image(x - 20, y - 20, id(pageicon_90)  , id(shiny_green) ); 
                  it.image(cx - 50, cy - 50, id(pageicon_90_big)  , id(shiny_green) ); 
                  break;
              }
            } 
          }


      # Raumselektion licht
      - id: p1000
        lambda: |-
          it.fill(black);
          const int cx = 120;
          const int cy = 120;
          Color selected_color = id(current_light_color);

          // Home-Button oben
          it.image(100, 15, id(pageicon_00), id(shiny_green));
          it.image(cx - 50, cy - 50, id(pageicon_10_big), id(darkest_green)); 

          // Zeichne Plus und Minus-Icon
          it.image( 10, 120 - 20, id(pageicon_minus), shiny_green);
          it.image(240 - 50, 120 - 20, id(pageicon_plus), shiny_green);

          std::string data = id(m5_list_lights).state;
          std::vector<std::string> rooms;
          size_t start = 0;
          size_t end;

          while ((end = data.find("¬ß", start)) != std::string::npos) {
            std::string block = data.substr(start, end - start);
            size_t sep = block.find(":");
            if (sep != std::string::npos) {
              std::string room = block.substr(0, sep);
              room.erase(0, room.find_first_not_of(" \t\n\r¬ß:"));
              room.erase(room.find_last_not_of(" \t\n\r¬ß:") + 1);
              rooms.push_back(room);
            }
            start = end + 1;
          }

          // Letzter Block nach dem letzten "¬ß"
          if (start < data.length()) {
            std::string block = data.substr(start);
            size_t sep = block.find(":");
            if (sep != std::string::npos) {
              std::string room = block.substr(0, sep);
              room.erase(0, room.find_first_not_of(" \t\n\r¬ß:"));
              room.erase(room.find_last_not_of(" \t\n\r¬ß:") + 1);
              rooms.push_back(room);
            }
          }

          // Kein Raum gefunden?
          if (rooms.empty()) {
            it.print(cx, cy, id(font_middle), TextAlign::CENTER, "Keine R√§ume");
            return;
          }

          // Raum ausw√§hlen per Subindex
          int room_index = id(selected_sub_index);
          if (room_index < 0) room_index = 0;
          if (room_index >= rooms.size()) room_index = rooms.size() - 1;

          std::string current_room = rooms[room_index];
          id(selected_light_room) = current_room;
          // ESP_LOGD("p1000", "Zeige Raum-Index %d: %s", room_index, current_room.c_str());


          // Raumname zentriert anzeigen
          it.print(cx, cy - 40, id(font_middle), shiny_green, TextAlign::CENTER, current_room.c_str());

          // MQTT Request senden
          // std::string topic = "m5dial/get/room/light/" + current_room;
          // id(mqtt_client)->publish(topic, "status");
          id(smart_mqtt_publish).execute("m5dial/get/room/light/" + current_room, "status", "p1000");

          // Balken f√ºr Helligkeit
          int brightness = id(current_light_brightness);  // 0‚Äì255
          int filled_bars = (brightness + 25) / 26;  // ca. 0‚Äì10 Balken

          for (int i = 0; i < 10; i++) 
          {
            int bx = 30 + i * 18;
            int by = cy + 50;
            it.rectangle(bx, by, 12, 20, darkest_green);
            if (i < filled_bars) 
            {
              it.filled_rectangle(bx + 1, by + 1, 10, 18, shiny_green);
            }
          }


          // Farbverlauf-Balken zeichnen (RGB)
          const int bar_x = 30;
          const int bar_y = 140;
          const int bar_w = 180;
          const int bar_h = 20;

          for (int x = 0; x < bar_w; x++) {
            float t = float(x) / float(bar_w - 1);
            uint8_t r, g, b;
            if (t < 1.0 / 6.0) {
              r = 255;
              g = uint8_t(t * 6.0f * 255.0f);
              b = 0;
            } else if (t < 2.0 / 6.0) {
              r = uint8_t((2.0f / 6.0f - t) * 6.0f * 255.0f);
              g = 255;
              b = 0;
            } else if (t < 3.0 / 6.0) {
              r = 0;
              g = 255;
              b = uint8_t((t - 2.0f / 6.0f) * 6.0f * 255.0f);
            } else if (t < 4.0 / 6.0) {
              r = 0;
              g = uint8_t((4.0f / 6.0f - t) * 6.0f * 255.0f);
              b = 255;
            } else if (t < 5.0 / 6.0) {
              r = uint8_t((t - 4.0f / 6.0f) * 6.0f * 255.0f);
              g = 0;
              b = 255;
            } else {
              r = 255;
              g = 0;
              b = uint8_t((1.0f - t) * 6.0f * 255.0f);
            }

            for (int y = 0; y < bar_h; y++) {
              it.draw_pixel_at(bar_x + x, bar_y + y, Color(r, g, b));
            }

            int delta = abs(int(r) - selected_color.r) + abs(int(g) - selected_color.g) + abs(int(b) - selected_color.b);
            if (delta < 40) {  // 30 ist die maximale Toleranz
              for (int y = -8; y < bar_h+8; y++) 
              {
                it.draw_pixel_at(bar_x + x, bar_y + y, Color(r, g, b));
              }
            }
            
          }

          // Hinweis
          it.printf(cx, 220, id(font_small), darkest_green, TextAlign::CENTER, "OK f√ºr Ger√§te");


      # lichter vom Raum selektion 
      - id: p10000
        lambda: |-
          it.fill(black);
          const int cx = 120;
          const int cy = 120;

          // Home-Button oben
          it.image(100, 15, id(pageicon_back), id(shiny_green));
          it.image(cx - 50, cy - 50, id(pageicon_10_big), id(darkest_green)); 


          std::string data = id(m5_list_lights).state;
          std::vector<std::string> room_blocks;
          size_t start = 0;
          size_t end;

          while ((end = data.find("\u00a7", start)) != std::string::npos) {
            room_blocks.push_back(data.substr(start, end - start));
            start = end + 1;
          }
          if (start < data.length()) {
            room_blocks.push_back(data.substr(start));
          }

          if (id(selected_sub_index) >= room_blocks.size()) return;
          std::string block = room_blocks[id(selected_sub_index)];
          size_t sep = block.find(":");
          if (sep == std::string::npos) return;

          std::string room_name = block.substr(0, sep);
          std::string devices_raw = block.substr(sep + 1);

          std::vector<std::string> devices;
          start = 0;
          while ((end = devices_raw.find(",", start)) != std::string::npos) {
            devices.push_back(devices_raw.substr(start, end - start));
            start = end + 1;
          }
          if (start < devices_raw.length()) {
            devices.push_back(devices_raw.substr(start));
          }

          if (devices.empty()) {
            it.print(cx, cy, id(font_middle), TextAlign::CENTER, "Keine Ger√§te");
            return;
          }

          int idx = id(selected_sub_sub_index);
          if (idx < 0) idx = 0;
          if (idx >= devices.size()) idx = devices.size() - 1;

          std::string device_line = devices[idx];
          size_t name_sep = device_line.find("|");
          std::string label = name_sep != std::string::npos ? device_line.substr(0, name_sep) : device_line;
          // Aus device_line extrahiert
          std::string entity = name_sep != std::string::npos ? device_line.substr(name_sep + 1) : "unknown";


          // Optional speichern
          id(selected_entity) = entity;

          // MQTT Request senden
          // std::string topic = "m5dial/get/light/" + entity;
          // id(mqtt_client)->publish(topic, "status");
          id(smart_mqtt_publish).execute("m5dial/get/room/light/" + entity, "status", "p10000");

          // Licht von Raum zentriert anzeigen
          it.print(cx, cy - 40, id(font_middle), shiny_green, TextAlign::CENTER,  label.c_str());


          // Balken f√ºr Helligkeit
          int brightness = id(current_light_brightness);  // 0‚Äì255
          int filled_bars = (brightness + 25) / 26;  // ca. 0‚Äì10 Balken

          for (int i = 0; i < 10; i++) 
          {
            int bx = 30 + i * 18;
            int by = cy + 50;
            it.rectangle(bx, by, 12, 20, darkest_green);
            if (i < filled_bars) 
            {
              it.filled_rectangle(bx + 1, by + 1, 10, 18, shiny_green);
            }
          }


          // Raumname √ºber ok
          it.printf(cx, 201, id(font_small), darkest_green, TextAlign::CENTER, "%s", room_name.c_str());
          //  ok
          it.printf(cx, 220, id(font_small), darkest_green, TextAlign::CENTER, "OK: zur Steuerung");


      - id: p100000
        lambda: |-
          it.fill(black);
          const int cx = 120;
          const int cy = 120;
          Color selected_color = id(current_light_color);


          // Home-Button oben
          it.image(100, 15, id(pageicon_back), id(shiny_green));

          // Hole Daten aus input_text
          std::string data = id(m5_list_lights).state;
          std::string selected_room = id(selected_light_room);
          int sub_index = id(selected_sub_sub_index);

          // Raum finden
          size_t room_start = data.find(selected_room + ":");
          if (room_start == std::string::npos) {
            it.print(cx, cy, id(font_middle), red, TextAlign::CENTER, "Kein Raum");
            return;
          }

          size_t room_end = data.find("¬ß", room_start);
          std::string room_block = data.substr(room_start, room_end - room_start);

          size_t sep = room_block.find(":");
          if (sep == std::string::npos) return;

          std::string devices_raw = room_block.substr(sep + 1);

          std::vector<std::string> devices;
          size_t start = 0;
          size_t end;
          while ((end = devices_raw.find(",", start)) != std::string::npos) {
            devices.push_back(devices_raw.substr(start, end - start));
            start = end + 1;
          }
          if (start < devices_raw.length()) {
            devices.push_back(devices_raw.substr(start));
          }

          // Anzeige Lichtstatus
          if (id(current_light_state)) 
          {
            it.image(cx - 50, cy - 50, id(pageicon_10_big)  , id(darkest_green) ); 
            it.image(39 - 20, 94 - 20, id(pageicon_light_off), shiny_red);
          } 
          else 
          {
            it.image(cx - 50, cy - 50, id(pageicon_10_big)  , id(darkest_red) ); 
            it.image(39 - 20, 94 - 20, id(pageicon_light_on), shiny_green);
          }


          if (devices.empty()) {
            it.print(cx, cy, id(font_middle), red, TextAlign::CENTER, "Keine Ger√§te");
            return;
          }

          if (sub_index < 0) sub_index = 0;
          if (sub_index >= devices.size()) sub_index = devices.size() - 1;

          std::string device_line = devices[sub_index];
          size_t name_sep = device_line.find("|");
          std::string label = name_sep != std::string::npos ? device_line.substr(0, name_sep) : device_line;


          // Anzeige Helligkeit (Balken)
          int brightness = id(current_light_brightness);
          int filled = (brightness * 180) / 255;

          for (int i = 0; i < 10; i++) {
            int bx = 30 + i * 18;
            int by = cy + 50;
            it.rectangle(bx, by, 12, 20, darkest_green);
            if (i * 18 < filled) {
              it.filled_rectangle(bx + 1, by + 1, 10, 18, shiny_green);
            }
          }

          it.printf(cx, cy + 80, id(font_small), dark_green, TextAlign::CENTER, "%d %%", (brightness * 100) / 255);

          // Farbverlauf-Balken zeichnen (RGB)
          const int bar_x = 30;
          const int bar_y = 140;
          const int bar_w = 180;
          const int bar_h = 20;

          for (int x = 0; x < bar_w; x++) {
            float t = float(x) / float(bar_w - 1);
            uint8_t r, g, b;
            if (t < 1.0 / 6.0) {
              r = 255;
              g = uint8_t(t * 6.0f * 255.0f);
              b = 0;
            } else if (t < 2.0 / 6.0) {
              r = uint8_t((2.0f / 6.0f - t) * 6.0f * 255.0f);
              g = 255;
              b = 0;
            } else if (t < 3.0 / 6.0) {
              r = 0;
              g = 255;
              b = uint8_t((t - 2.0f / 6.0f) * 6.0f * 255.0f);
            } else if (t < 4.0 / 6.0) {
              r = 0;
              g = uint8_t((4.0f / 6.0f - t) * 6.0f * 255.0f);
              b = 255;
            } else if (t < 5.0 / 6.0) {
              r = uint8_t((t - 4.0f / 6.0f) * 6.0f * 255.0f);
              g = 0;
              b = 255;
            } else {
              r = 255;
              g = 0;
              b = uint8_t((1.0f - t) * 6.0f * 255.0f);
            }

            for (int y = 0; y < bar_h; y++) {
              it.draw_pixel_at(bar_x + x, bar_y + y, Color(r, g, b));
            }

            int delta = abs(int(r) - selected_color.r) + abs(int(g) - selected_color.g) + abs(int(b) - selected_color.b);
            if (delta < 40) {  // 30 ist die maximale Toleranz
              for (int y = -8; y < bar_h+8; y++) 
              {
                it.draw_pixel_at(bar_x + x, bar_y + y, Color(r, g, b));
              }
            }
            
          }



          // Ger√§temame unten
          it.print(cx, 220, id(font_small), darkest_green, TextAlign::CENTER, label.c_str());


